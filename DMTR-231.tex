% generated from JIRA project LVV
% using template at /usr/local/lib/python3.7/site-packages/docsteady/templates/dm-tpr.latex.jinja2.
% using docsteady version 1.2rc24
% Please do not edit -- update information in Jira instead

\documentclass[DM,lsstdraft,STR,toc]{lsstdoc}
\usepackage{geometry}
\usepackage{longtable,booktabs}
\usepackage{enumitem}
\usepackage{arydshln}
\usepackage{attachfile}
\usepackage{array}

\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}

\input meta.tex

\newcommand{\attachmentsUrl}{https://github.com/\gitorg/\lsstDocType-\lsstDocNum/blob/\gitref/attachments}
\providecommand{\tightlist}{
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

\setcounter{tocdepth}{4}

\begin{document}

\def\milestoneName{ComCam OPS Readiness}
\def\milestoneId{LDM-503-11a}
\def\product{Data Management}

\setDocCompact{true}

\title{LDM-503-11a: ComCam OPS Readiness Test Plan and Report}
\setDocRef{\lsstDocType-\lsstDocNum}
\date{\vcsdate}
\author{ Robert Gruendl }

\input{history_and_info.tex}


\setDocAbstract{
This is the test plan and report for
\textbf{ ComCam OPS Readiness} (LDM-503-11a),
an LSST milestone pertaining to the Data Management Subsystem.
}


\maketitle

\section{Introduction}
\label{sect:intro}


\subsection{Objectives}
\label{sect:objectives}

 This test plan verifies that DM software is ready to obtain and process
ComCam observations. ~Since this test campaign is needed prior to on-sky
data acquisition the tests are necessarily focused on the ability to
process test-stand data. ~Therefore, the elements focus on the generic
ability to process ComCam data.



\subsection{System Overview}
\label{sect:systemoverview}

 The system requires an operating ComCam at the Summit or on a test stand
(either at the Base or Tucson). ~LDM-503-06 will have already shown that
data acquisition (DAQ), archiver, header service, transfer mechanism,
and ingest to the DBB are functional. ~Those systems are re-verified by
this test as: 1) changes will almost certainly have occurred and 2) for
this test to succeed the data must be properly formed and ingested for
processing to succeed.\\[2\baselineskip]

\subsection{Applicable Documents}\label{applicable-documents}

\citeds{LDM-503}: Data Management Test Plan\\
\citeds{LDM-639}: Data Management Acceptance Test Specification


\subsection{Document Overview}
\label{sect:docoverview}

This document was generated from Jira, obtaining the relevant information from the
\href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testPlan/LVV-P76}{LVV-P76}
~Jira Test Plan and related Test Cycles (
\href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testCycle/LVV-C159}{LVV-C159}
).

Section \ref{sect:intro} provides an overview of the test campaign, the system under test (\product{}),
the applicable documentation, and explains how this document is organized.
Section \ref{sect:testplan} provides additional information about the test plan, like for example the configuration
used for this test or related documentation.
Section \ref{sect:personnel} describes the necessary roles and lists the individuals assigned to them.

Section \ref{sect:overview} provides a summary of the test results, including an overview in Table \ref{table:summary},
an overall assessment statement and suggestions for possible improvements.
Section \ref{sect:detailedtestresults} provides detailed results for each step in each test case.

The current status of test plan \href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testPlan/LVV-P76}{LVV-P76} in Jira is \textbf{ Approved }.

\subsection{References}
\label{sect:references}
\renewcommand{\refname}{}
\bibliography{lsst,refs,books,refs_ads,local}


\newpage
\section{Test Plan Details}
\label{sect:testplan}


\subsection{Data Collection}

  Observing is not required for this test campaign.

\subsection{Verification Environment}
\label{sect:hwconf}
  This test assumes a working DBB (Data BackBone) where raw ComCam data
are available and ingested into a Butler repository (can be Gen2 or
Gen3). ~Alternatively, the Base OODS (Observatory Operations Data
System) could be used for these tests. ~In either case (DBB or OODS)
compute hardware must be available that can see the DBB (USDF) or OODS
(Base compute). ~ A current DM production stack should be used but the
tests do not require more than a single node (and could run on a
single-core).

  \subsection{Entry Criteria}
  ComCam produces data with proper headers and can be transferred to the
USDF.

  \subsection{Exit Criteria}
  Successful ingest and processing of ComCam data with pipeline tasks in
the DM stack and resultant data products made available through an LSP
instance.


\subsection{Related Documentation}


No additional documentation provided.


\subsection{PMCS Activity}

Primavera milestones related to the test campaign:
LDM-503-11a: ~ComCam Ops Readiness


\newpage
\section{Personnel}
\label{sect:personnel}

The personnel involved in the test campaign is shown in the following table.

{\small
\begin{longtable}{p{3cm}p{3cm}p{3cm}p{6cm}}
\hline
\multicolumn{2}{r}{T. Plan \href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testPlan/LVV-P76}{LVV-P76} owner:} &
\multicolumn{2}{l}{\textbf{ Robert Gruendl } }\\\hline
\multicolumn{2}{r}{T. Cycle \href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testCycle/LVV-C159}{LVV-C159} owner:} &
\multicolumn{2}{l}{\textbf{
Robert Gruendl }
} \\\hline
\textbf{Test Cases} & \textbf{Assigned to} & \textbf{Executed by} & \textbf{Additional Test Personnel} \\ \hline
\href{https://jira.lsstcorp.org/secure/Tests.jspa#/testCase/LVV-T1935}{LVV-T1935}
& {\small Robert Gruendl } & {\small Robert Gruendl } &
\begin{minipage}[]{6cm}
\smallskip
{\small  }
\medskip
\end{minipage}
\\ \hline
\href{https://jira.lsstcorp.org/secure/Tests.jspa#/testCase/LVV-T1934}{LVV-T1934}
& {\small Robert Gruendl } & {\small Robert Gruendl } &
\begin{minipage}[]{6cm}
\smallskip
{\small  }
\medskip
\end{minipage}
\\ \hline
\end{longtable}
}

\newpage

\section{Test Campaign Overview}
\label{sect:overview}

\subsection{Summary}
\label{sect:summarytable}

{\small
\begin{longtable}{p{2cm}cp{2.3cm}p{8.6cm}p{2.3cm}}
\toprule
\multicolumn{2}{r}{ T. Plan \href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testPlan/LVV-P76}{LVV-P76}:} &
\multicolumn{2}{p{10.9cm}}{\textbf{ LDM-503-11a: ComCam OPS Readiness }} & Approved \\\hline
\multicolumn{2}{r}{ T. Cycle \href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testCycle/LVV-C159}{LVV-C159}:} &
\multicolumn{2}{p{10.9cm}}{\textbf{ LDM-503-11a: ComCam OPS Readiness }} & Done \\\hline
\textbf{Test Cases} &  \textbf{Ver.} & \textbf{Status} & \textbf{Comment} & \textbf{Issues} \\\toprule
\href{https://jira.lsstcorp.org/secure/Tests.jspa#/testCase/LVV-T1935}{LVV-T1935}
&  1
& Pass &
\begin{minipage}[]{9cm}
\smallskip
Test script was executed by verifying that processing during OPS
Rehearsal 2 generated the expected calibrations and ingested same into
the calibration repository in the shared file area (currently
/project/shared/comCam).
\medskip
\end{minipage}
&   \\\hline
\href{https://jira.lsstcorp.org/secure/Tests.jspa#/testCase/LVV-T1934}{LVV-T1934}
&  1
& Pass &
\begin{minipage}[]{9cm}
\smallskip
Data transfer from ComCam (temporarily installed in the Base Data
Center) have been routinely performed since July 2020. ~ On the day this
test was executed (2020-10-28) the Data BackBone endpoint at NCSA was
checked for recently transferred data and then the shared repository was
checked to make sure that the data were ingested and made generally
available.
\medskip
\end{minipage}
&   \\\hline
\caption{Test Campaign Summary}
\label{table:summary}
\end{longtable}
}

\subsection{Overall Assessment}
\label{sect:overallassessment}

LVV-P76 was executed on 2020-10-28. ~During that execution it was
demonstrated that ComCam data taken in the Base Data Center is
successfully being transferred, archived and ingested (made available
for use to DM staff) at the current USDF (NCSA). ~Furthermore it was
verified that during the OPS Rehearsal \#2 that bias and flat frames
were routinely processed and used to form calibration products
(demonstrating DM is capable of processing ComCam data).

\subsection{Recommended Improvements}
\label{sect:recommendations}

Execution of the current plan occurred using a Gen2 Butler
implementation. ~It is recommended that these tests should be
re-verified once ComCam is installed at the summit facility and the DM
stack is using the Gen3 Butler implementation for processing data.

\newpage
\section{Detailed Test Results}
\label{sect:detailedtestresults}

\subsection{Test Cycle LVV-C159 }

Open test cycle {\it \href{https://jira.lsstcorp.org/secure/Tests.jspa#/testrun/LVV-C159}{LDM-503-11a: ComCam OPS Readiness}} in Jira.

Test Cycle name: LDM-503-11a: ComCam OPS Readiness\\
Status: Done

Test that ComCam data can be received in the DBB, be made available and
processed with results also made available to DM staff.

\subsubsection{Software Version/Baseline}
Not provided.

\subsubsection{Configuration}
ComCam operating at Base/Summit in a test stand capable of delivering
image to USDF. ~Data Backbone endpoint and OODS (Observatory Operations
Data Service) ready to receive and ingest data.

\subsubsection{Test Cases in LVV-C159 Test Cycle}

\paragraph{ LVV-T1935 - Demonstrate ComCam Data Processing Capability }\mbox{}\\

Version \textbf{1}.
Open  \href{https://jira.lsstcorp.org/secure/Tests.jspa#/testCase/LVV-T1935}{\textit{ LVV-T1935 } }
test case in Jira.

To process raw ComCam data and demonstrate that the results are
available either in the shared DM development environment/repository or
in the LSP.

\textbf{ Preconditions}:\\
ComCam data acquisition and ingest are nominal. ~(LVV-T1934)

Execution status: {\bf Pass }

Final comment:\\Test script was executed by verifying that processing during OPS
Rehearsal 2 generated the expected calibrations and ingested same into
the calibration repository in the shared file area (currently
/project/shared/comCam).


Detailed steps results:

\begin{longtable}{p{1cm}p{15cm}}
\hline
{Step} & Step Details\\ \hline
1 & Description \\
 & \begin{minipage}[t]{15cm}
{\footnotesize
Obtain BIAS and FLAT sequences (minimum of 3 exposures each)

\medskip }
\end{minipage}
\\ \cdashline{2-2}

 & Test Data \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Acquired from ComCam Archiver.

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Expected Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Data acquired, ingested, and available in shared work space.

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Actual Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
During OPS rehearsal \#2 (see DMTN-159) bias and flat sequences were
acquired. ~Using the first night as an example:\\[2\baselineskip]cd
/project/shared/comCam\\
sqlite3 \_parent/registry.sqlite3\\
expId,dayObs,imageType,raftName,detectorName from raw where
dayObs='2020-07-27';\\[2\baselineskip]Shows sufficient BIAS and FLAT
data have been properly ingested to the shared work-space.

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Status: \textbf{ Pass } \\ \hline

2 & Description \\
 & \begin{minipage}[t]{15cm}
{\footnotesize
Process BIAS frames

\medskip }
\end{minipage}
\\ \cdashline{2-2}

 & Test Data \\
 & \begin{minipage}[t]{15cm}{\footnotesize
From Step 1

\medskip }
\end{minipage} \\ \cdashline{2-2}
 & Example Code \\
 & \begin{minipage}[t]{15cm}{\footnotesize
\begin{verbatim}
setenv REPODIR=/projects/shared/comCam
setenv VER_DIR={verification_dir}

constructBias.py $REPODIR --rerun $VER_DIR \
    --id expId=2020070800001^2020070800002^2020070800003 --batch-type none -c isr.doCrosstalk=False -j 9

ingestCalibs.py $REPODIR $REPODIR/rerun/$VER_DIR/bias/*/*.fits --validity 9999 --mode=link --calib $REPODIR/CALIB
\end{verbatim}

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Expected Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Successful execution of BIAS reduction software (currently~

\begin{verbatim}
constructBias.py and ingestion)
\end{verbatim}

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Actual Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
The processing notes that accompany DMTN-159 (are available in the
github
repo~\href{https://github.com/lsst-dm/OPS_Rehearsal_2}{OPS\_Rehearsal\_2}).
There we find that constructBias.py and ingestCalibs.py were executed
and find in the calibration repo the associated ingested bias
entries:\\[2\baselineskip]cd /project/shared/comCam\\
sqlite3 CALIB/calibRegistry.sqlite3\\
select * from bias where calibDate='2020-07-27';\\
1\textbar{}NONE\textbar{}R22\textbar{}S00\textbar{}0\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
2\textbar{}NONE\textbar{}R22\textbar{}S01\textbar{}1\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
3\textbar{}NONE\textbar{}R22\textbar{}S02\textbar{}2\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
4\textbar{}NONE\textbar{}R22\textbar{}S10\textbar{}3\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
5\textbar{}NONE\textbar{}R22\textbar{}S11\textbar{}4\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
6\textbar{}NONE\textbar{}R22\textbar{}S12\textbar{}5\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
7\textbar{}NONE\textbar{}R22\textbar{}S20\textbar{}6\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
8\textbar{}NONE\textbar{}R22\textbar{}S21\textbar{}7\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
9\textbar{}NONE\textbar{}R22\textbar{}S22\textbar{}8\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Status: \textbf{ Pass } \\ \hline

3 & Description \\
 & \begin{minipage}[t]{15cm}
{\footnotesize
Process FLAT frames

\medskip }
\end{minipage}
\\ \cdashline{2-2}

 & Test Data \\
 & \begin{minipage}[t]{15cm}{\footnotesize
From Step 1 (and step 2)

\medskip }
\end{minipage} \\ \cdashline{2-2}
 & Example Code \\
 & \begin{minipage}[t]{15cm}{\footnotesize
\begin{verbatim}
setenv REPODIR=/projects/shared/comCam
setenv VER_DIR={verification_dir}
\end{verbatim}

\begin{verbatim}
constructFlat.py $REPODIR --rerun $VER_DIR \
    --id expId=2020070100152..2020070100154 filter=r --batch-type none -j 9 -c isr.doCrosstalk=False
\end{verbatim}

\begin{verbatim}
ingestCalibs.py $REPODIR $REPODIR/rerun/$VER_DIR/flat/*/*.fits \
    --validity 9999 --mode=link --calib $REPODIR/CALIB
\end{verbatim}

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Expected Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Successful execution of FLAT reduction software (currently
constructFlat.py and ingestion)

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Actual Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Similar to step 2:\\[2\baselineskip]select * from flat where
calibDate='2020-07-27';\\
1\textbar{}r\textbar{}R22\textbar{}S00\textbar{}0\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
2\textbar{}r\textbar{}R22\textbar{}S01\textbar{}1\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
3\textbar{}r\textbar{}R22\textbar{}S02\textbar{}2\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
4\textbar{}r\textbar{}R22\textbar{}S10\textbar{}3\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
5\textbar{}r\textbar{}R22\textbar{}S11\textbar{}4\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
6\textbar{}r\textbar{}R22\textbar{}S12\textbar{}5\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
7\textbar{}r\textbar{}R22\textbar{}S20\textbar{}6\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
8\textbar{}r\textbar{}R22\textbar{}S21\textbar{}7\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28\\
9\textbar{}r\textbar{}R22\textbar{}S22\textbar{}8\textbar{}2020-07-27\textbar{}1993-03-12\textbar{}2020-07-28

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Status: \textbf{ Pass } \\ \hline

\end{longtable}

\paragraph{ LVV-T1934 - ComCam Data Transfer and Ingestion }\mbox{}\\

Version \textbf{1}.
Open  \href{https://jira.lsstcorp.org/secure/Tests.jspa#/testCase/LVV-T1934}{\textit{ LVV-T1934 } }
test case in Jira.

Verify that ComCam Archiver data taken are transferred to USDF Data
BackBone endpoint and Ingested

\textbf{ Preconditions}:\\
Operating ComCam and Base or Summit (test-stand or mounted on TMA)

Execution status: {\bf Pass }

Final comment:\\Data transfer from ComCam (temporarily installed in the Base Data
Center) have been routinely performed since July 2020. ~ On the day this
test was executed (2020-10-28) the Data BackBone endpoint at NCSA was
checked for recently transferred data and then the shared repository was
checked to make sure that the data were ingested and made generally
available.


Detailed steps results:

\begin{longtable}{p{1cm}p{15cm}}
\hline
{Step} & Step Details\\ \hline
1 & Description \\
 & \begin{minipage}[t]{15cm}
{\footnotesize
Trigger Exposure through OCS+Archiver

\medskip }
\end{minipage}
\\ \cdashline{2-2}

 & Test Data \\
 & \begin{minipage}[t]{15cm}{\footnotesize
generated by ComCam as part of test

\medskip }
\end{minipage} \\ \cdashline{2-2}
 & Example Code \\
 & \begin{minipage}[t]{15cm}{\footnotesize


\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Expected Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Ingested ComCam exposure (9 files) at USDF in shared Butler Repo (raw).
~

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Actual Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Data are being routinely generate with ComCam installed at the Base Data
Center. ~ I have verified that new data were generated toady
(2020-10-28) and transferred to current USDF (NCSA) and the DBB endpoint
for raw data exists and has data ~(i.e. files transfer has been placing
new data in:
~/lsstdata/offline/teststand/comcam/Archiver/storage/2020-10-28 )

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Status: \textbf{ Pass } \\ \hline

2 & Description \\
 & \begin{minipage}[t]{15cm}
{\footnotesize
Check for presence of ingested raw data at USDF

\medskip }
\end{minipage}
\\ \cdashline{2-2}

 & Test Data \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Data produced in Step 1

\medskip }
\end{minipage} \\ \cdashline{2-2}
 & Example Code \\
 & \begin{minipage}[t]{15cm}{\footnotesize
\# note: currently assumes butler Gen2 (from USDF machine)\\
cd /project/shared/comCam\\
sqlite3 \_parent/registry.sqlite3\\
select expId,dayObs,raftName,detectorName from raw where expId=\{expo
generated in step 1\};

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Expected Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
query of repo registry finds appropriate data entries showing a single
raft and 9 detectors

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Actual Result \\
 & \begin{minipage}[t]{15cm}{\footnotesize
Following the example above the most recent raw exposure to have arrived
at USDF had expId 2020102800060.\\
The following was generated when using that
expId:\\[2\baselineskip]select expId,dayObs,raftName,detectorName from
raw where expId=2020102800060;\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S00\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S01\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S02\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S10\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S11\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S12\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S20\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S21\\
2020102800060\textbar{}2020-10-28\textbar{}R22\textbar{}S22\\[2\baselineskip]Confirming
successful ingestion into the shared Gen2 repo at NCSA.~

\medskip }
\end{minipage} \\ \cdashline{2-2}

 & Status: \textbf{ Pass } \\ \hline

\end{longtable}


\input{appendix.tex}
\end{document}
